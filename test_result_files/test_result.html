<!DOCTYPE html>
<!-- saved from url=(0183)https://jenkins.dte.devops.prod.k8s.osp.dataeng.internal/job/DTE.PR_MANAGER_FOR_IAG_EDH_DATA/19218/result/pub_restricted.ds_consumption_party_portfolio_event_16059_20231204103626.html -->
<html class="no-js" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  

  <title>checkbot result</title>
  <meta name="description" content="{% block meta_description %}{% endblock %}">
  <meta name="author" content="{% block meta_author %}{% endblock %}">
  <link rel="stylesheet" href="./test_result_files/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="./test_result_files/jquery-1.10.2.js"></script>
  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="./test_result_files/jquery.min.js"></script>
  <script src="./test_result_files/jquery-1.12.0.min.js"></script>
  <script src="./test_result_files/highlight.min.js"></script>
  <script src="./test_result_files/highlightjs-line-numbers.min.js"></script><style type="text/css">.hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}</style>
  <script>hljs.initHighlightingOnLoad();
          hljs.initLineNumbersOnLoad();
  </script>
  <style>
    /* for block of numbers */
    .hljs-ln td.hljs-ln-numbers {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;

      text-align: right;
      color: #ccc;
      border-right: 1px solid #CCC;
      vertical-align: top;
      padding-right: 5px;

      /* your custom style here */
    }

    /* for block of code */
    .hljs-ln td.hljs-ln-code {
      padding-left: 20px;
    }

    @media print {

      /* All your print styles go here */
      #header,
      #footer,
      #nav {
        display: none !important;
      }
    }

    @media print {
      tr.vendorListHeading {
        background-color: #1a4567 !important;
        -webkit-print-color-adjust: exact;
      }
    }

    .extra {
      background-color: #4CAF50;
      /* Green */
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
    }

    .boxed_red {
      border: 2px solid red;
    }

    .boxed_green {
      border: 2px solid green;
    }

    .boxed_yellow {
      border: 2px solid yellow;
    }

    .boxed_pink {
      border: 2px solid pink;
    }

    .boxed_brown {
      border: 2px solid brown;
    }

    .boxed_magenta {
      border: 2px solid darkmagenta;
    }

    .boxed_blue {
      border: 2px solid blue;
    }
  </style>
  <style>
    .hljs {
      display: block;
      overflow-x: auto;
      padding: 0.5em;
      color: #333;
      background: #f8f8f8;
    }

    .hljs-comment,
    .hljs-quote {
      color: #998;
      font-style: italic;
    }

    .hljs-keyword,
    .hljs-selector-tag,
    .hljs-subst {
      color: #333;
      font-weight: bold;
    }

    .hljs-number,
    .hljs-literal,
    .hljs-variable,
    .hljs-template-variable,
    .hljs-tag .hljs-attr {
      color: #008080;
    }

    .hljs-string,
    .hljs-doctag {
      color: #d14;
    }

    .hljs-title,
    .hljs-section,
    .hljs-selector-id {
      color: #900;
      font-weight: bold;
    }

    .hljs-subst {
      font-weight: normal;
    }

    .hljs-type,
    .hljs-class .hljs-title {
      color: #458;
      font-weight: bold;
    }

    .hljs-tag,
    .hljs-name,
    .hljs-attribute {
      color: #000080;
      font-weight: normal;
    }

    .hljs-regexp,
    .hljs-link {
      color: #009926;
    }

    .hljs-symbol,
    .hljs-bullet {
      color: #990073;
    }

    .hljs-built_in,
    .hljs-builtin-name {
      color: #0086b3;
    }

    .hljs-meta {
      color: #999;
      font-weight: bold;
    }

    .hljs-deletion {
      background: #fdd;
    }

    .hljs-addition {
      background: #dfd;
    }

    .hljs-emphasis {
      font-style: italic;
    }

    .hljs-strong {
      font-weight: bold;
    }
  </style>
  <style>
    img.resize {
      max-width: 3%;
      max-height: 3%;
    }
  </style>
  <style>
    .it .btn-orange {
      background-color: blue;
      border-color: #777 !important;
      color: #777;
      text-align: left;
      width: 100%;
    }

    .it input.form-control {

      border: none;
      margin-bottom: 0px;
      border-radius: 0px;
      border-bottom: 1px solid #ddd;
      box-shadow: none;
    }

    .it .form-control:focus {
      border-color: #ff4d0d;
      box-shadow: none;
      outline: none;
    }

    .fileUpload {
      position: relative;
      overflow: hidden;
    }

    .fileUpload input.upload {
      position: absolute;
      top: 0;
      right: 0;
      margin: 0;
      padding: 0;
      font-size: 20px;
      cursor: pointer;
      opacity: 0;
      filter: alpha(opacity=0);
    }
  </style>
      <style>
        ul,
        #myUL {
            list-style-type: none;
        }

        #myUL {
            margin: 0;
            padding: 0;
        }

        .box {
            cursor: pointer;
            -webkit-user-select: none;
            /* Safari 3.1+ */
            -moz-user-select: none;
            /* Firefox 2+ */
            -ms-user-select: none;
            /* IE 10+ */
            user-select: none;
        }

        .box::before {
            content: "\2610";
            color: black;
            display: inline-block;
            margin-right: 6px;
        }

        .check-box::before {
            content: "\2611";
            color: dodgerblue;
        }

        .nested {
            display: none;
        }

        .active {
            display: block;
        }
    </style>

<style>
  nav {
  position:fixed;
  left:0px;
  top:0px;
  }
  </style>
  <!-- {{ stylesheet_tag('main_css') | safe }} -->

  <!-- {% block css %}{% endblock %} -->

</head>

<body style="">
    <div id="content">
        <div class="container">
          <br><br>
          <center>
            <!-- <h2>Code Review: pub_restricted.ds_consumption_party_portfolio_event <a href="object_dependenceis_tree_link"><font size="1">dependence tree</font></a></h2> -->
            <h2 class="display-6">Code Review: pub_restricted.ds_consumption_party_portfolio_event</h2>
            <!-- <h6>dependence tree unavailable</h6> -->
            <h6><a href="https://github.customerlabs.com.au/iagcl/iag-edh-data/pull/16059"> Pull Request : 16059</a></h6>
          </center>
          <div class="row">
            <div class="col-lg-3">
            </div><!-- /.col-lg-6 -->
    
    
          </div><!-- /.row -->
          <table id="table" class="table table-hover">
            <thead>
              <tr>
                <th>Severity</th>
                <th>Type</th>
                <th>Threshold</th>
                <th>Count</th>
                <th>Description</th>
                <th>Recommendation</th>
              </tr>
            </thead>
            <tbody>
              
                        <tr>
                            <td><font color="orange">Warning</font></td>
                            <td><span class="boxed_yellow">Lower Case</span></td>
                            <td></td>
                            <td> 1</td>
                            <td>The file has 1 non-lower case.</td>
                            <td>All table / function / view names, column names and alias names should be lower case. Please review and replace them with lower case.<br> Please refer to <a href="https://iag.atlassian.net/wiki/spaces/CLD/pages/408436402/4.+SQL+Syntax+Standards">4.1 Naming Standards</a></td>
                        </tr>
                    
                        <tr>
                            <td><font color="orange">Warning</font></td>
                            <td><span class="boxed_blue">Type Cast</span></td>
                            <td>10</td>
                            <td> 29</td>
                            <td>The code has 29 data type casts.</td>
                            <td>Please review data typecasts used and remove unnecessary casting.<br>Please refer to 4.3 in <a href="https://iag.atlassian.net/wiki/spaces/CLD/pages/408436402/4.+SQL+Syntax+Standards">SQL Syntax Standards</a></td>
                        </tr>
                    
                        <tr>
                            <td><font color="orange">Warning</font></td>
                            <td><span class="boxed_green">Dependencies</span></td>
                            <td>7</td>
                            <td> 14</td>
                            <td>If a new object creates more than certain number of dependencies or existing object creates more than 7 new horizontal dependencies at CTX_EXT or PUB_CORE levels.</td>
                            <td>The PR has created 14 new horizontal dependencies. <br>Please recheck all existing views and update the PR to confirm all new dependencies are required.<br>Please refer to <a href="https://iag.atlassian.net/wiki/spaces/CLD/pages/407687594/EDH+Code+Best+Practices"> EDH Code Best Practices </a></td>
                        </tr>
                    
                        <tr>
                            <td><font color="orange">Warning</font></td>
                            <td><span class="boxed_magenta">Distinct</span></td>
                            <td></td>
                            <td> 3</td>
                            <td>The code has 3 DISTINCT in the SELECT statement</td>
                            <td>Please recheck to confirm if GROUP BY could be used to replace DISTINCT instead.<br>Please refer to <a href="https://iag.atlassian.net/wiki/spaces/CLD/pages/407687594/EDH+Code+Best+Practices"> EDH Code Best Practices </a></td>
                        </tr>
                    
            </tbody>
          </table>
    
        </div>
      </div>
      
      <div>
        <pre class="SQL"><code class="hljs"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- --------------------------------------------------------------------------------------------------------------------------------------------------</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- Author: Jasminka Dukic-Jovicevic</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- Description: CLP loyalty rewards data. Confluence page: https://iag.atlassian.net/wiki/spaces/CDD/pages/362644361/CLP+Loyalty+Rewards+-+MDL2+customer+info</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- Dependencies:</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">consumption.tb_coverable_common</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.integration_portfolio</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.integration_party</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.conformed_party_portfolio_cmdm</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.conformed_party_external_reference_cmdm</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.integration_party_portfolio_event_history</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     dbt_consumption_customer.customer_journey_interaction</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bc_policyperiod</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bc_policy</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bc_unappliedfund</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bc_invoicestream</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bc_paymentinstrument</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_bc.bctl_paymentmethod</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">sor_au_pc.pctl_iag_cardtype</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">--     </span><span class="boxed_green"><span class="hljs-comment">mod_svx.integration_cntrl_job_management</span></span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- --------------------------------------------------------------------------------------------------------------------------------------------------</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- VERSION        DATE          WHO                     DESCRIPTION</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- 1.0.0          2023-11-28    Jasminka DJ             Initial Release</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- --------------------------------------------------------------------------------------------------------------------------------------------------</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">view</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span> pub_restricted.ds_consumption_party_portfolio_event <span class="hljs-keyword">cascade</span>;</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">view</span> pub_restricted.ds_consumption_party_portfolio_event <span class="hljs-keyword">as</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">with</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">cte_last_run <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span> <span class="hljs-keyword">coalesce</span>(<span class="hljs-keyword">max</span>(start_time) - <span class="hljs-string">'2 hours'</span>::<span class="hljs-built_in">interval</span>, <span class="hljs-keyword">current_date</span> - <span class="hljs-string">'1 days'</span>::<span class="hljs-built_in">interval</span>) <span class="hljs-keyword">as</span> last_load</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- cntrl_job_management table is used by python code that sends records to KAFKA</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> <span class="boxed_green">mod_svx.integration_cntrl_job_management</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> object_name <span class="hljs-keyword">like</span> <span class="hljs-string">'%consumption_party_portfolio_event_clp'</span> <span class="hljs-comment">-- the view is used in the python code</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> job_status = <span class="hljs-string">'SUCCESS'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">,cte_times <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span> last_load,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">now</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">now</span>() - last_load <span class="hljs-keyword">as</span> diff_hrs,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> - <span class="hljs-string">'22 days'</span>::<span class="hljs-built_in">interval</span> <span class="hljs-keyword">as</span> day_22,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        (<span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> - (<span class="hljs-string">'36 days'</span>::<span class="hljs-built_in">interval</span> + <span class="hljs-keyword">now</span>() - last_load))::<span class="hljs-built_in">date</span> <span class="hljs-keyword">as</span> day_36_from, <span class="hljs-comment">-- capture days that were not processed for added/created (if any)</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> - <span class="hljs-string">'46 days'</span>::<span class="hljs-built_in">interval</span> <span class="hljs-keyword">as</span> day_46,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        (<span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> - (<span class="hljs-string">'46 days'</span>::<span class="hljs-built_in">interval</span> + <span class="hljs-keyword">now</span>() - last_load))::<span class="hljs-built_in">date</span> <span class="hljs-keyword">as</span> day_46_from <span class="hljs-comment">-- capture days that were not processed for renwals (if any)</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> cte_last_run</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">,cte_added_created_risk <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_key'</span> <span class="hljs-keyword">as</span> coverable_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_brand_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'policy_term_type'</span> <span class="hljs-keyword">as</span> policy_term_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_start_date_time,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.product_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'product_model_variation_code'</span> <span class="hljs-keyword">as</span> product_model_variation_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'product_model_variation_desc'</span> <span class="hljs-keyword">as</span> product_model_variation_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_risk_state_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_term_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_term_business_key ,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_expiration_date'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_expiration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'default_billing_payment_method_name'</span> <span class="hljs-keyword">as</span> default_billing_payment_method_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.public_party_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_outcome_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> dbt_consumption_customer.customer_journey_interaction  cji</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> cji.event_id <span class="hljs-keyword">in</span> (<span class="hljs-string">'197'</span>, <span class="hljs-string">'198'</span>) <span class="hljs-comment">-- RISK_CREATED, RISK_ADDED</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &gt;= t.day_36_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span>  &lt; t.day_22</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">cte_removed_risk <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_term_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_term_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_start_date_time,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_expiration_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span>  <span class="hljs-keyword">as</span> coverable_expiration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'version_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span>  <span class="hljs-keyword">as</span> version_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_outcome_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> dbt_consumption_customer.customer_journey_interaction cji</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> cji.event_id = <span class="hljs-string">'200'</span> <span class="hljs-comment">-- RISK_REMOVED</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cji.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &gt;= t.day_46_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">cte_reinstated_risk <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">max</span>(cji.event_start_date_time) <span class="hljs-keyword">as</span> max_reinstatment_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> dbt_consumption_customer.customer_journey_interaction cji</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> cji.event_id = <span class="hljs-string">'202'</span> <span class="hljs-comment">-- RISK_REINSTATEMENT</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &gt;= t.day_46_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> cji.<span class="boxed_yellow">Policy_number</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">,cte_cancelled_risk <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_term_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_term_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_start_date_time,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_expiration_date'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_expiration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt; <span class="hljs-string">'version_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> version_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_outcome_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-comment">-- if cancelled date is before re-instatment date, then the policy has been re-instated, otherwise it was cancelled</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-comment">-- coalesce is for the policies that don't have re-instatment events</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> cji.event_start_date_time &lt;= <span class="hljs-keyword">coalesce</span>(crr.max_reinstatment_date, cji.event_start_date_time -<span class="hljs-string">'1 days'</span>::<span class="hljs-built_in">INTERVAL</span> )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">then</span> <span class="hljs-string">'Reinstated'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Cancelled'</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> policy_state</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> dbt_consumption_customer.customer_journey_interaction cji</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_reinstated_risk crr <span class="hljs-keyword">on</span> cji.policy_number = crr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> cji.event_id = <span class="hljs-string">'199'</span> <span class="hljs-comment">-- RISK_CANCELLED</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &gt;= t.day_46_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">cte_renewed_risk <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_key'</span> <span class="hljs-keyword">as</span> coverable_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_brand_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'policy_term_type'</span> <span class="hljs-keyword">as</span> policy_term_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_start_date_time,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.product_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'product_model_variation_code'</span> <span class="hljs-keyword">as</span> product_model_variation_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'product_model_variation_desc'</span> <span class="hljs-keyword">as</span> product_model_variation_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.policy_risk_state_code,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_term_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_term_business_key ,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_in_policy_business_key'</span> <span class="hljs-keyword">as</span> coverable_in_policy_business_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_migrated_flag'</span> <span class="hljs-keyword">as</span> coverable_migrated_flag,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_effective_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> coverable_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'coverable_expiration_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span>  <span class="hljs-keyword">as</span> coverable_expiration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'default_billing_payment_method_name'</span> <span class="hljs-keyword">as</span> default_billing_payment_method_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.legacy_policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.legacy_policy_brand_code_source,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'policy_migrated_date'</span> = <span class="hljs-string">''</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">null</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span> to_timestamp(cji.other_info_nonpii-&gt;&gt;<span class="hljs-string">'policy_migrated_date'</span>, <span class="hljs-string">'YYYY-MM-DD HH24:SS:MI'</span> )::<span class="hljs-built_in">timestamp</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> policy_migrated_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.public_party_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">'Risk Renewed'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> event_outcome_desc,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        cji.event_id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> dbt_consumption_customer.customer_journey_interaction cji</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">where</span> cji.event_id = <span class="hljs-string">'203'</span> <span class="hljs-comment">-- RISK_RENEWAL_EFFECTIVE</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &gt;= t.day_46_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cji.event_start_date_time::<span class="hljs-built_in">date</span> &lt;= t.day_46</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">cte_invoice_stream <span class="hljs-keyword">as</span> (</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    bpp.policynumber,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    bpp.policypereffdate,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    bpp.policyperexpirdate,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rpm.name <span class="hljs-keyword">as</span> payment_method,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rct.name <span class="hljs-keyword">as</span> credit_card_provider,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    row_number() <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> bpp.policynumber <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ins.createtime <span class="hljs-keyword">desc</span>) <span class="hljs-keyword">as</span> latest_invoice_stream</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">from</span> <span class="boxed_green">sor_au_bc.bc_policyperiod</span> bpp</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_bc.bc_policy</span> pol <span class="hljs-keyword">on</span> bpp.policyid = pol.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_bc.bc_unappliedfund</span> buf <span class="hljs-keyword">on</span> buf.policyid = pol.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_bc.bc_invoicestream</span> ins <span class="hljs-keyword">on</span> ins.unappliedfundid = buf.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_bc.bc_paymentinstrument</span> bpi <span class="hljs-keyword">on</span> ins.overridingpaymentinstrumentid = bpi.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_bc.bctl_paymentmethod</span> rpm <span class="hljs-keyword">on</span> bpi.paymentmethod = rpm.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">sor_au_pc.pctl_iag_cardtype</span> rct <span class="hljs-keyword">on</span> bpi.iag_cardtype = rct.id</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'GPC'</span> source_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.policy_brand_code <span class="hljs-keyword">as</span> brand_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.event_outcome_desc <span class="hljs-keyword">as</span> event_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.event_start_date_time event_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">greatest</span>(cr.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'21 days'</span>::<span class="hljs-built_in">interval</span>,  cc.coverable_first_payment_date) <span class="hljs-keyword">as</span> qualification_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(po.portfolio_key, <span class="hljs-string">'GPC-'</span>||cr.policy_number) <span class="hljs-keyword">as</span> portfolio_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.policy_number <span class="hljs-keyword">as</span> policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> <span class="hljs-keyword">count</span>(<span class="boxed_magenta"><span class="hljs-keyword">distinct</span></span> cpp.party_key) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> cr.<span class="boxed_yellow">Policy_number</span>) &gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'Joint'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Individual'</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> policy_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    po.policy_status,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.policy_term_type term_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.coverable_in_policy_business_key <span class="hljs-keyword">as</span> risk_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'N'</span> <span class="hljs-keyword">as</span> risk_migrated_flag,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.coverable_effective_date <span class="hljs-keyword">as</span> term_start_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.coverable_expiration_date <span class="hljs-keyword">as</span> term_end_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.coverable_first_payment_date <span class="hljs-keyword">as</span> payment_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.policy_risk_state_code <span class="hljs-keyword">as</span> asset_state,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.product_model_variation_code ||<span class="hljs-string">'~'</span>|| cr.product_model_variation_desc <span class="hljs-keyword">as</span> product_description,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cr.product_desc <span class="hljs-keyword">as</span> product_category,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(ic.payment_method, cr.default_billing_payment_method_name) <span class="hljs-keyword">as</span> payment_method,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ic.credit_card_provider,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.total_gross_written_premium <span class="hljs-keyword">as</span> premium_amount_value,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'AUD'</span> <span class="hljs-keyword">as</span> premium_amount_currency,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || cr.public_party_id)  <span class="hljs-keyword">as</span> party_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.public_party_id, cr.public_party_id) <span class="hljs-keyword">as</span> public_party_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    per.reference_value <span class="hljs-keyword">as</span> clp_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    p.party_type <span class="hljs-keyword">as</span> party_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(cpp.portfolio_role_name, <span class="hljs-string">'Primary Policy Holder'</span>) <span class="hljs-keyword">as</span> party_role,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> legacy_policy_brand,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> legacy_policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">Null</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> legacy_migration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cpp.jurisdiction,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_expiry_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'I'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_change,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'A'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_status</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> cte_added_created_risk cr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> <span class="boxed_green">consumption.tb_coverable_common</span> cc <span class="hljs-keyword">on</span> cc.coverable_key = cr.coverable_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.policy_status_name = <span class="hljs-string">'Bound'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.md_source_system_code = <span class="hljs-string">'PC_AU'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_invoice_stream ic <span class="hljs-keyword">on</span> ic.policynumber = cr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">   <span class="hljs-keyword">and</span> ic.latest_invoice_stream = <span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_portfolio_cmdm</span> cpp <span class="hljs-keyword">on</span> cpp.portfolio_key=<span class="hljs-string">'GPC-'</span>||cr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cpp.portfolio_role_code <span class="hljs-keyword">like</span> <span class="hljs-string">'%_POLICY_HOLDER'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">greatest</span>(cr.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'21 days'</span>::<span class="hljs-built_in">interval</span>, cc.coverable_first_payment_date)<span class="hljs-comment">-- ie qualification_date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">between</span> cpp.party_portfolio_effective_start_date <span class="hljs-keyword">and</span> cpp.party_portfolio_effective_end_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_portfolio</span> po <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.portfolio_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> cpp.portfolio_key = po.portfolio_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.portfolio_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> po.portfolio_key = <span class="hljs-string">'GPC-'</span>||cr.policy_number) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.md_row_status =<span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party</span> p <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = <span class="hljs-string">'CMDM-'</span> || cr.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.party_status = <span class="hljs-string">'CURRENT'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.md_row_status = <span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_external_reference_cmdm</span> per <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = <span class="hljs-string">'CMDM-'</span> || cr.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_type = <span class="hljs-string">'CLP_ID'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_status_code = <span class="hljs-string">'ACTIVE'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- history table helps remove records already sent to Kafka</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party_portfolio_event_history</span> h <span class="hljs-keyword">on</span> h.policy_number= cr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.risk_key = cr.coverable_in_policy_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.party_key = <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || cr.public_party_id)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">coalesce</span>(h.clp_id, <span class="hljs-string">'x'</span>) = <span class="hljs-keyword">coalesce</span>(per.reference_value, <span class="hljs-string">'x'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_type = cr.event_outcome_desc</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_date = cr.event_start_date_time</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">where</span> cr.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">from</span> cte_cancelled_risk cn</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">where</span> cn.coverable_in_policy_term_business_key = cr.coverable_in_policy_term_business_key <span class="hljs-keyword">and</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-comment">-- risk cancelled before risk effective date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ( (cr.coverable_effective_date &gt;= cn.event_start_date_time::<span class="hljs-built_in">date</span> ) <span class="hljs-keyword">OR</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          (cr.coverable_effective_date &lt; cn.event_start_date_time::<span class="hljs-built_in">date</span> <span class="hljs-keyword">and</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-comment">-- risk cancelled within 21 days from first issued date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          cn.version_effective_date &lt; cr.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'22 days'</span>::<span class="hljs-built_in">interval</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">and</span> cn.policy_state = <span class="hljs-string">'Cancelled'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cr.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">from</span> cte_removed_risk rr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">where</span> cr.coverable_in_policy_term_business_key = rr.coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-comment">-- risk removed within 21 days from first issued date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">and</span> rr.version_effective_date &lt; cr.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'22 days'</span>::<span class="hljs-built_in">interval</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.total_paid_premium &gt;<span class="hljs-number">0</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.coverable_first_payment_date &lt; cr.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'36 days'</span>::<span class="hljs-built_in">interval</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cr.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> (h.risk_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> h.fail_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">or</span> h.sent_flag <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cr.event_id = <span class="hljs-string">'197'</span> <span class="hljs-comment">-- RISK_CREATED</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- CANCELLED included for rare occasions when a larger run window is run (more than 1 day)</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- and risk was cancelled after day 21 which makes customer eligible for loyalty points</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.policy_status <span class="hljs-keyword">in</span> (<span class="hljs-string">'CURRENT'</span>, <span class="hljs-string">'CANCELLED'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cr.event_start_date_time::<span class="hljs-built_in">date</span> &gt; t.day_36_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cr.event_start_date_time::<span class="hljs-built_in">date</span> &lt; t.day_22</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'GPC'</span> source_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.policy_brand_code <span class="hljs-keyword">as</span> brand_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.event_outcome_desc <span class="hljs-keyword">as</span> event_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.event_start_date_time <span class="hljs-keyword">as</span> event_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">greatest</span>(ar.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'21 days'</span>::<span class="hljs-built_in">interval</span>, cc.coverable_first_payment_date) <span class="hljs-keyword">as</span> qualification_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    po.portfolio_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.policy_number <span class="hljs-keyword">as</span> policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> <span class="hljs-keyword">count</span>(<span class="boxed_magenta"><span class="hljs-keyword">distinct</span></span> cpp.party_key)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> ar.<span class="boxed_yellow">Policy_number</span>)&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'Joint'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Individual'</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> policy_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    po.policy_status,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.policy_term_type <span class="hljs-keyword">as</span> term_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.coverable_in_policy_business_key <span class="hljs-keyword">as</span> risk_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'N'</span> <span class="hljs-keyword">as</span> risk_migrated_flag,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.coverable_effective_date <span class="hljs-keyword">as</span> term_start_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.coverable_expiration_date <span class="hljs-keyword">as</span> term_end_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.coverable_first_payment_date <span class="hljs-keyword">as</span> payment_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.policy_risk_state_code <span class="hljs-keyword">as</span> asset_state,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.product_model_variation_code ||<span class="hljs-string">'~'</span>|| ar.product_model_variation_desc <span class="hljs-keyword">as</span> product_description,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ar.product_desc <span class="hljs-keyword">as</span> product_category,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(ic.payment_method, ar.default_billing_payment_method_name) <span class="hljs-keyword">as</span> payment_method,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ic.credit_card_provider,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.total_gross_written_premium <span class="hljs-keyword">as</span> premium_amount_value,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'AUD'</span> <span class="hljs-keyword">as</span> premium_amount_currency,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || ar.public_party_id)  <span class="hljs-keyword">as</span> party_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.public_party_id, ar.public_party_id) <span class="hljs-keyword">as</span> public_party_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    per.reference_value <span class="hljs-keyword">as</span> clp_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    p.party_type <span class="hljs-keyword">as</span> party_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(cpp.portfolio_role_name, <span class="hljs-string">'Primary Policy Holder'</span>) <span class="hljs-keyword">as</span> party_role,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> legacy_policy_brand,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> legacy_policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> legacy_migration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cpp.jurisdiction,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_expiry_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'I'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_change,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'A'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_status</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> cte_added_created_risk ar</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> <span class="boxed_green">consumption.tb_coverable_common</span> cc <span class="hljs-keyword">on</span> cc.coverable_key = ar.coverable_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.policy_status_name = <span class="hljs-string">'Bound'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.md_source_system_code = <span class="hljs-string">'PC_AU'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_invoice_stream ic <span class="hljs-keyword">on</span> ic.policynumber = ar.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">   <span class="hljs-keyword">and</span> ic.latest_invoice_stream = <span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_portfolio_cmdm</span> cpp <span class="hljs-keyword">on</span> cpp.portfolio_key=<span class="hljs-string">'GPC-'</span>||ar.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cpp.portfolio_role_code <span class="hljs-keyword">like</span> <span class="hljs-string">'%_POLICY_HOLDER'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">greatest</span>(ar.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'21 days'</span>::<span class="hljs-built_in">interval</span>, cc.coverable_first_payment_date)::<span class="hljs-built_in">date</span> <span class="hljs-comment">-- ie qualification_date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">between</span> cpp.party_portfolio_effective_start_date <span class="hljs-keyword">and</span> cpp.party_portfolio_effective_end_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_portfolio</span> po <span class="hljs-keyword">on</span> po.portfolio_key = <span class="hljs-string">'GPC-'</span>||ar.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.md_row_status =<span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party</span> p <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = <span class="hljs-string">'CMDM-'</span> || ar.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.party_status = <span class="hljs-string">'CURRENT'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.md_row_status = <span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_external_reference_cmdm</span> per <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = <span class="hljs-string">'CMDM-'</span> || ar.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_type  = <span class="hljs-string">'CLP_ID'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_status_code = <span class="hljs-string">'ACTIVE'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- history table removes records already sent to Kafka</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party_portfolio_event_history</span> h <span class="hljs-keyword">on</span> h.policy_number= ar.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.risk_key = ar.coverable_in_policy_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.party_key = <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || ar.public_party_id)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">coalesce</span>(h.clp_id, <span class="hljs-string">'x'</span>) = <span class="hljs-keyword">coalesce</span>(per.reference_value, <span class="hljs-string">'x'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_type = ar.event_outcome_desc</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_date = ar.event_start_date_time</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">where</span> ar.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">from</span> cte_cancelled_risk cn</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">where</span> cn.coverable_in_policy_term_business_key = ar.coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-comment">-- risk cancelled within 21 days from first issued date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">and</span> cn.version_effective_date &lt; ar.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'22 days'</span>::<span class="hljs-built_in">interval</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">and</span> cn.policy_state = <span class="hljs-string">'Cancelled'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ar.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">from</span> cte_removed_risk rr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">where</span> ar.coverable_in_policy_term_business_key = rr.coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-comment">-- risk removed within 21 days from first issued date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">and</span> rr.version_effective_date &lt; ar.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'22 days'</span>::<span class="hljs-built_in">interval</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.coverable_added_paid_premium &gt;<span class="hljs-number">0</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.coverable_first_payment_date &lt; ar.event_start_date_time::<span class="hljs-built_in">date</span> + <span class="hljs-string">'36 days'</span>::<span class="hljs-built_in">interval</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.coverable_paid_flag <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ar.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> (h.risk_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> h.fail_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">or</span> h.sent_flag <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="354"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ar.event_id = <span class="hljs-string">'198'</span> <span class="hljs-comment">-- RISK_ADDED</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="355"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- RENEWAL added to include added risks close to the policy's renewal date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="356"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- CANCELLED included for rare occasions when a larger run window is run (more than 1 day)</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="357"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- and risk was cancelled after day 21 which makes customer eligible for loyalty points</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="358"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.policy_status <span class="hljs-keyword">in</span> (<span class="hljs-string">'CURRENT'</span>, <span class="hljs-string">'CANCELLED'</span>, <span class="hljs-string">'RENEWAL'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="359"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ar.event_start_date_time::<span class="hljs-built_in">date</span> &gt; t.day_36_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="360"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ar.event_start_date_time::<span class="hljs-built_in">date</span> &lt; t.day_22</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="361"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="362"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">select</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="363"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'GPC'</span> source_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="364"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.policy_brand_code <span class="hljs-keyword">as</span> brand_name,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="365"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.event_outcome_desc <span class="hljs-keyword">as</span> event_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="366"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.coverable_effective_date <span class="hljs-keyword">as</span> event_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="367"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">greatest</span>(rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> + <span class="hljs-string">'45 days'</span>::<span class="hljs-built_in">interval</span>,  cc.coverable_first_payment_date)  <span class="hljs-keyword">as</span> qualification_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="368"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    po.portfolio_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="369"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="370"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> <span class="hljs-keyword">count</span>(<span class="boxed_magenta"><span class="hljs-keyword">distinct</span></span> cpp.party_key) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> rr.<span class="boxed_yellow">Policy_number</span>)&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'Joint'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Individual'</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> policy_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="371"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    po.policy_status,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="372"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.policy_term_type <span class="hljs-keyword">as</span> term_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="373"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.coverable_in_policy_business_key <span class="hljs-keyword">as</span> risk_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="374"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.coverable_migrated_flag <span class="hljs-keyword">as</span> risk_migrated_flag,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="375"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.coverable_effective_date <span class="hljs-keyword">as</span> term_start_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="376"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.coverable_expiration_date <span class="hljs-keyword">as</span> term_end_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="377"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.coverable_first_payment_date <span class="hljs-keyword">as</span> payment_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="378"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.policy_risk_state_code <span class="hljs-keyword">as</span> asset_state,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="379"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.product_model_variation_code ||<span class="hljs-string">'~'</span>|| rr.product_model_variation_desc <span class="hljs-keyword">as</span> product_description,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="380"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    rr.product_desc <span class="hljs-keyword">as</span> product_category,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="381"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(ic.payment_method, rr.default_billing_payment_method_name) <span class="hljs-keyword">as</span> payment_method,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="382"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ic.credit_card_provider,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="383"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cc.total_gross_written_premium <span class="hljs-keyword">as</span> premium_amount_value,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="384"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'AUD'</span> <span class="hljs-keyword">as</span> premium_amount_currency,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="385"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || rr.public_party_id)  <span class="hljs-keyword">as</span> party_key,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="386"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(p.public_party_id, rr.public_party_id) <span class="hljs-keyword">as</span> public_party_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="387"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    per.reference_value <span class="hljs-keyword">as</span> clp_id,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="388"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    p.party_type <span class="hljs-keyword">as</span> party_type,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="389"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">coalesce</span>(cpp.portfolio_role_name, <span class="hljs-string">'Primary Policy Holder'</span>) <span class="hljs-keyword">as</span> party_role,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="390"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> rr.coverable_migrated_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">then</span> rr.legacy_policy_brand_code_source <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> legacy_policy_brand,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="391"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> rr.coverable_migrated_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">then</span> rr.legacy_policy_number <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> legacy_policy_number,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="392"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> rr.coverable_migrated_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">then</span> rr.policy_migrated_date <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> legacy_migration_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="393"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    cpp.jurisdiction,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="394"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">now</span>()::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_effective_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="395"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-literal">null</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">as</span> md_row_expiry_date,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="396"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'I'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_change,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="397"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">'A'</span>::<span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> md_row_status</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="398"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> cte_renewed_risk rr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="399"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> <span class="boxed_green">consumption.tb_coverable_common</span> cc <span class="hljs-keyword">on</span> cc.coverable_key = rr.coverable_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="400"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="401"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.policy_status_name = <span class="hljs-string">'Bound'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="402"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.md_source_system_code = <span class="hljs-string">'PC_AU'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="403"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_invoice_stream ic <span class="hljs-keyword">on</span> ic.policynumber = rr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="404"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> ic.latest_invoice_stream = <span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="405"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_portfolio_cmdm</span> cpp <span class="hljs-keyword">on</span> cpp.portfolio_key=<span class="hljs-string">'GPC-'</span>||rr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="406"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cpp.portfolio_role_code <span class="hljs-keyword">like</span> <span class="hljs-string">'%_POLICY_HOLDER'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="407"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">greatest</span>(rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> + <span class="hljs-string">'45 days'</span>::<span class="hljs-built_in">interval</span>, cc.coverable_first_payment_date)::<span class="hljs-built_in">date</span> <span class="hljs-comment">-- ie qualification_date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="408"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">between</span> cpp.party_portfolio_effective_start_date <span class="hljs-keyword">and</span> cpp.party_portfolio_effective_end_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="409"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_portfolio</span> po <span class="hljs-keyword">on</span> po.portfolio_key = <span class="hljs-string">'GPC-'</span>||rr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="410"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.md_row_status =<span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="411"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party</span> p <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="412"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="413"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> p.party_key = <span class="hljs-string">'CMDM-'</span> || rr.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="414"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.party_status = <span class="hljs-string">'CURRENT'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="415"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> p.md_row_status = <span class="hljs-string">'A'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="416"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.conformed_party_external_reference_cmdm</span> per <span class="hljs-keyword">on</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="417"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = cpp.party_key) <span class="hljs-keyword">or</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="418"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      (cpp.party_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> per.party_key = <span class="hljs-string">'CMDM-'</span> || rr.public_party_id) )</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="419"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_type  = <span class="hljs-string">'CLP_ID'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="420"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> per.reference_status_code = <span class="hljs-string">'ACTIVE'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="421"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> cte_times t <span class="hljs-keyword">on</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="422"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment">-- history table helps remove records already sent to Kafka</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="423"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> <span class="boxed_green">mod_svx.integration_party_portfolio_event_history</span> h <span class="hljs-keyword">on</span> h.policy_number= rr.policy_number</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="424"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.risk_key = rr.coverable_in_policy_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="425"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.party_key = <span class="hljs-keyword">coalesce</span>(p.party_key, <span class="hljs-string">'CMDM-'</span> || rr.public_party_id)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="426"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> <span class="hljs-keyword">coalesce</span>(h.clp_id, <span class="hljs-string">'x'</span>) = <span class="hljs-keyword">coalesce</span>(per.reference_value, <span class="hljs-string">'x'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="427"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_type = rr.event_outcome_desc</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="428"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> h.event_date = rr.coverable_effective_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="429"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">where</span> rr.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="430"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="431"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">from</span> cte_cancelled_risk cn</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="432"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">where</span> cn.coverable_in_policy_term_business_key = rr.coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="433"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-comment">-- risk cancelled within 45 days from coverable effective date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="434"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">and</span> cn.version_effective_date &lt; rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> + <span class="hljs-string">'46 days'</span>::<span class="hljs-built_in">interval</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="435"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">and</span> cn.policy_state = <span class="hljs-string">'Cancelled'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="436"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> rr.coverable_in_policy_term_business_key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="437"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      ( <span class="hljs-keyword">select</span> coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="438"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">from</span> cte_removed_risk rrm</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="439"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">where</span> rrm.coverable_in_policy_term_business_key = rr.coverable_in_policy_term_business_key</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="440"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-comment">-- risk removed within 45 days from coverable effective date</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="441"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">and</span> rrm.version_effective_date &lt; rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> + <span class="hljs-string">'46 days'</span>::<span class="hljs-built_in">interval</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="442"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> cc.renewal_paid_premium &gt;<span class="hljs-number">0</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="443"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> rr.policy_brand_code = <span class="hljs-string">'NRMA'</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="444"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- CANCELLED included for rare occasions when a larger run window is run (more than 1 day)</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="445"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- and risk was cancelled after day 45 which makes customer eligible for loyalty points</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="446"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> po.policy_status <span class="hljs-keyword">in</span> (<span class="hljs-string">'CURRENT'</span>, <span class="hljs-string">'CANCELLED'</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="447"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> (h.risk_key <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> h.fail_flag = <span class="hljs-string">'Y'</span> <span class="hljs-keyword">or</span> h.sent_flag <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="448"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-comment">-- if run window is more than a day, need to exclude the events that have been paid later than 45 days</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="449"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> rr.coverable_effective_date + <span class="hljs-string">'45 days'</span>::<span class="hljs-built_in">interval</span> &gt;=  cc.coverable_first_payment_date</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="450"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> &gt; t.day_46_from</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="451"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">and</span> rr.<span class="boxed_blue">coverable_effective_date::<span class="hljs-built_in">date</span></span> &lt;= t.day_46;</div></td></tr></tbody></table></code></pre>
      </div>
      <!--<div id="content">
        <h1>
            We support special element handlers. Register them with jQuery-style.
        </h1>
    </div> -->
    <script src="./test_result_files/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="./test_result_files/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="./test_result_files/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


</body></html>